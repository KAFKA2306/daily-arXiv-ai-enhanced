name: arXivæ¯æ—¥AIæ‹¡å¼µ

on:
  schedule:
    - cron: "0 21 * * *"
  workflow_dispatch:
    inputs:
      date:
        description: "å‡¦ç†å¯¾è±¡æ—¥ (YYYY-MM-DD, çœç•¥ã§UTCå½“æ—¥)"
        required: false
        type: string
      language:
        description: "è¨€èª (Japanese/English ãªã©)"
        required: false
        type: string
      categories:
        description: "arXivã‚«ãƒ†ã‚´ãƒªï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰"
        required: false
        type: string
      model_name:
        description: "LLMãƒ¢ãƒ‡ãƒ«å (ä¾‹: gemini-2.5-pro-preview)"
        required: false
        type: string

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: github-pages
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    environment: github-pages
    outputs:
      has_new_content: ${{ steps.dedup_check.outputs.has_new_content }}
      skip_reason: ${{ steps.dedup_check.outputs.skip_reason }}
    steps:
      - uses: actions/checkout@v4

      - name: Varsã‚’ç¢ºèªãƒ»è¨­å®š
        run: |
          # Set defaults if vars are not set
          echo "LANGUAGE=${{ vars.LANGUAGE || 'Japanese' }}" >> $GITHUB_ENV
          echo "CATEGORIES=${{ vars.CATEGORIES || 'cs.AI,cs.LG,cs.CL,cs.CV,stat.ML' }}" >> $GITHUB_ENV
          echo "MODEL_NAME=${{ vars.MODEL_NAME || 'gemini-2.5-pro-preview' }}" >> $GITHUB_ENV
          echo "MIN_INTERVAL_SECONDS=${{ vars.MIN_INTERVAL_SECONDS || '60' }}" >> $GITHUB_ENV
          
          # Debug output
          echo "LANGUAGE=${{ vars.LANGUAGE || 'Japanese' }}"
          echo "CATEGORIES=${{ vars.CATEGORIES || 'cs.AI,cs.LG,cs.CL,cs.CV,stat.ML' }}"
          echo "MODEL_NAME=${{ vars.MODEL_NAME || 'gemini-2.5-pro-preview' }}"
          echo "MIN_INTERVAL_SECONDS=${{ vars.MIN_INTERVAL_SECONDS || '60' }}"

      - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        uses: astral-sh/setup-uv@v3
        with:
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: ä¾å­˜é–¢ä¿‚ã‚’åŒæœŸ
        run: |
          uv sync

      - name: arXivè«–æ–‡ã‚’ã‚¯ãƒ­ãƒ¼ãƒ«
        id: crawl_step
        run: |
          source .venv/bin/activate
          if [ -n "${{ inputs.date }}" ]; then
            today="${{ inputs.date }}"
          else
            today=$(date -u "+%Y-%m-%d")
          fi
          echo "æœ¬æ—¥ $today ã® arXiv è«–æ–‡ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’é–‹å§‹ã—ã¾ã™..."

          # å½“æ—¥ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèªã—ã€å­˜åœ¨ã™ã‚‹å ´åˆã¯å‰Šé™¤ã—ã¦å†ä½œæˆ
          if [ -f "data/${today}.jsonl" ]; then
              echo "ğŸ—‘ï¸ æœ¬æ—¥ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ—¢ã«å­˜åœ¨ã™ã‚‹ãŸã‚å‰Šé™¤ã—ã¦ä½œã‚Šç›´ã—ã¾ã™..."
              rm "data/${today}.jsonl"
              echo "âœ… æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã¾ã—ãŸ: data/${today}.jsonl"
          else
              echo "ğŸ“ æœ¬æ—¥ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯å­˜åœ¨ã—ãªã„ãŸã‚æ–°è¦ä½œæˆã—ã¾ã™..."
          fi

          cd daily_arxiv
          export OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
          export OPENAI_BASE_URL=${{ secrets.OPENAI_BASE_URL }}
          export LANGUAGE="${{ env.LANGUAGE }}"
          export CATEGORIES="${{ env.CATEGORIES }}"
          export MODEL_NAME="${{ env.MODEL_NAME }}"
          if [ -n "${{ vars.MAX_PAPERS }}" ]; then
            export MAX_PAPERS="${{ vars.MAX_PAPERS }}"
            echo "MAX_PAPERS=$MAX_PAPERS"
          else
            echo "MAX_PAPERS=default(10)"
          fi
          if [ -n "${{ vars.SORT_BY }}" ]; then
            export SORT_BY="${{ vars.SORT_BY }}"
            echo "SORT_BY=$SORT_BY"
          else
            echo "SORT_BY=default(popularity)"
          fi
          if [ -n "${{ vars.SORT_ORDER }}" ]; then
            export SORT_ORDER="${{ vars.SORT_ORDER }}"
            echo "SORT_ORDER=$SORT_ORDER"
          else
            echo "SORT_ORDER=default(desc)"
          fi
          echo "LANGUAGE=$LANGUAGE"
          echo "CATEGORIES=$CATEGORIES"

          # MODEL_NAME ãŒæœªè¨­å®šã®éš›ã«å‚™ãˆã¦ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’æä¾›
          if [ -z "$MODEL_NAME" ]; then
            export MODEL_NAME="gemini-2.5-pro-preview"
          fi
          if [ -z "$OPENAI_BASE_URL" ] && [[ "$MODEL_NAME" == gemini-* ]]; then
            export OPENAI_BASE_URL="https://generativelanguage.googleapis.com/v1beta/openai"
          fi

          scrapy crawl arxiv -o ../data/${today}.jsonl

          if [ ! -f "../data/${today}.jsonl" ]; then
              echo "ã‚¯ãƒ­ãƒ¼ãƒ«ã«å¤±æ•—ã—ã€ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ"
              exit 1
          fi

          echo "crawl_date=$today" >> $GITHUB_OUTPUT
          echo "ã‚¯ãƒ­ãƒ¼ãƒ«ãŒå®Œäº†ã—ã¾ã—ãŸ"

      - name: é‡è¤‡ã‚’ç¢ºèª
        id: dedup_check
        run: |
          source .venv/bin/activate
          echo "é‡è¤‡é™¤å»ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™..."

          cd daily_arxiv
          set +e
          python daily_arxiv/check_stats.py
          dedup_exit_code=$?
          set -e

          echo "é‡è¤‡é™¤å»ãƒã‚§ãƒƒã‚¯ã®çµ‚äº†ã‚³ãƒ¼ãƒ‰: $dedup_exit_code"
          echo "dedup_exit_code=$dedup_exit_code" >> $GITHUB_OUTPUT

          case $dedup_exit_code in
              0)
                  echo "has_new_content=true" >> $GITHUB_OUTPUT
                  ;;
              1)
                  echo "has_new_content=false" >> $GITHUB_OUTPUT
                  echo "skip_reason=no_new_content" >> $GITHUB_OUTPUT
                  ;;
              2)
                  echo "has_new_content=false" >> $GITHUB_OUTPUT
                  echo "skip_reason=processing_error" >> $GITHUB_OUTPUT
                  exit 1
                  ;;
              *)
                  echo "âŒ ä¸æ˜ãªçµ‚äº†ã‚³ãƒ¼ãƒ‰ã®ãŸã‚ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’åœæ­¢ã—ã¾ã™"
                  echo "has_new_content=false" >> $GITHUB_OUTPUT
                  echo "skip_reason=unknown_error" >> $GITHUB_OUTPUT
                  exit 1
                  ;;
          esac

      - name: AIå¼·åŒ–å‡¦ç†
        if: steps.dedup_check.outputs.has_new_content == 'true'
        run: |
          source .venv/bin/activate
          today=${{ steps.crawl_step.outputs.crawl_date }}
          echo "AIå¼·åŒ–å‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™..."

          cd ai
          export OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
          export OPENAI_BASE_URL=${{ secrets.OPENAI_BASE_URL }}
          export LANGUAGE="${{ env.LANGUAGE }}"
          export MODEL_NAME="${{ env.MODEL_NAME }}"
          export MIN_INTERVAL_SECONDS="${{ env.MIN_INTERVAL_SECONDS }}"
          if [ -z "$MODEL_NAME" ]; then
            export MODEL_NAME="gemini-2.5-pro-preview"
          fi
          if [ -z "$OPENAI_BASE_URL" ] && [[ "$MODEL_NAME" == gemini-* ]]; then
            export OPENAI_BASE_URL="https://generativelanguage.googleapis.com/v1beta/openai"
          fi

          python enhance.py --data ../data/${today}.jsonl --min-interval-secs "$MIN_INTERVAL_SECONDS"
          if [ $? -ne 0 ]; then
              echo "AIå‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ"
              exit 1
          fi
          echo "AIå¼·åŒ–å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸ"

      - name: Markdownã¸å¤‰æ›
        if: steps.dedup_check.outputs.has_new_content == 'true'
        run: |
          source .venv/bin/activate
          today=${{ steps.crawl_step.outputs.crawl_date }}
          echo "Markdown å½¢å¼ã¸ã®å¤‰æ›ã‚’é–‹å§‹ã—ã¾ã™..."

          export LANGUAGE="${{ env.LANGUAGE }}"
          cd to_md
          AI_FILE="../data/${today}_AI_enhanced_${LANGUAGE}.jsonl"

          if [ -f "$AI_FILE" ]; then
              echo "AIå¼·åŒ–ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”¨ã„ã¦å¤‰æ›ã—ã¦ã„ã¾ã™..."
              python convert.py --data "$AI_FILE"
          else
              echo "ã‚¨ãƒ©ãƒ¼: AIå¼·åŒ–ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
              echo "AIãƒ•ã‚¡ã‚¤ãƒ«: $AI_FILE"
              exit 1
          fi

          if [ $? -ne 0 ]; then
              echo "Markdownå¤‰æ›ã«å¤±æ•—ã—ã¾ã—ãŸ"
              exit 1
          fi
          echo "Markdownå¤‰æ›ãŒå®Œäº†ã—ã¾ã—ãŸ"

      - name: ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’æ›´æ–°
        if: steps.dedup_check.outputs.has_new_content == 'true'
        run: |
          echo "ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’æ›´æ–°ã—ã¦ã„ã¾ã™..."
          ls data/*.jsonl | sed 's|data/||' > assets/file-list.txt
          echo "ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã®æ›´æ–°ãŒå®Œäº†ã—ã¾ã—ãŸ"

      - name: READMEã‚«ã‚¿ãƒ­ã‚°ã‚’æ›´æ–°
        if: steps.dedup_check.outputs.has_new_content == 'true'
        run: |
          if [ -f "update_readme.py" ]; then
            source .venv/bin/activate
            python update_readme.py
          else
            echo "READMEãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚‰ãªã„ãŸã‚ update_readme.py ã®å®Ÿè¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™"
          fi

      - name: ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒã‚·ãƒ¥ã‚’ç”Ÿæˆã—ã¦è¨­å®šã«åæ˜ 
        if: steps.dedup_check.outputs.has_new_content == 'true'
        env:
          ACCESS_PASSWORD: ${{ secrets.ACCESS_PASSWORD }}
        run: |
          echo "ğŸ” èªè¨¼ç”¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒã‚·ãƒ¥ã‚’ç”Ÿæˆã—ã¦ã„ã¾ã™..."

          if [ -z "$ACCESS_PASSWORD" ]; then
            echo "âš ï¸  è­¦å‘Š: Secrets ã« ACCESS_PASSWORD ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
            PASSWORD_HASH="DISABLED_NO_PASSWORD_SET_IN_SECRETS"
          else
            PASSWORD_HASH=$(echo -n "$ACCESS_PASSWORD" | openssl dgst -sha256 -hex | awk '{print $2}')
            echo "âœ… ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒã‚·ãƒ¥ã®ç”Ÿæˆã«æˆåŠŸã—ã¾ã—ãŸ"
          fi
          export PASSWORD_HASH

          if [ ! -f "js/auth-config.js" ]; then
            echo "âŒ ã‚¨ãƒ©ãƒ¼: js/auth-config.js ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi

          python3 -c "import os,re; from pathlib import Path; hash_value = os.environ.get('PASSWORD_HASH', 'DISABLED_NO_PASSWORD_SET_IN_SECRETS'); path = Path('js/auth-config.js'); text = path.read_text(); if 'passwordHash' not in text: raise SystemExit('auth-config.js ã« passwordHash ã‚­ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“'); new_text = re.sub(r\"(passwordHash:\\s*)'[^']+'\", rf\"\\1'{hash_value}'\", text, count=1); path.write_text(new_text)"

          echo "ğŸ” èªè¨¼è¨­å®šãŒå®Œäº†ã—ã¾ã—ãŸ"

      - name: ã‚µãƒãƒªãƒ¼
        run: |
          if [ "${{ steps.dedup_check.outputs.has_new_content }}" = "true" ]; then
            echo "âœ… ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Œäº†: é‡è¤‡é™¤å»ã§æ–°ã—ã„å†…å®¹ã‚’æ¤œå‡ºã—æ­£å¸¸ã«å‡¦ç†ã—ã¾ã—ãŸ"
          else
            case "${{ steps.dedup_check.outputs.skip_reason }}" in
              "no_new_content")
                echo "â„¹ï¸ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Œäº†: é‡è¤‡é™¤å»å¾Œã«æ–°ã—ã„å†…å®¹ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ"
                ;;
              "processing_error")
                echo "âš ï¸ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Œäº†: é‡è¤‡å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"
                ;;
              "unknown_error")
                echo "âš ï¸ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Œäº†: ä¸æ˜ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"
                ;;
              *)
                echo "â„¹ï¸ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Œäº†: ä¸æ˜ãªç†ç”±ã§å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸ"
                ;;
            esac
          fi

      - name: å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆ
        if: steps.dedup_check.outputs.has_new_content == 'true'
        run: |
          git config --global user.email "${{ vars.EMAIL || 'github-actions[bot]@users.noreply.github.com' }}"
          git config --global user.name "${{ vars.NAME || 'github-actions[bot]' }}"
          git add .
          if git diff --staged --quiet; then
            echo "ã‚³ãƒŸãƒƒãƒˆã™ã¹ãå¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“"
            exit 0
          fi
          git commit -m "update: $(date -u '+%Y-%m-%d') arXiv papers"
          echo "å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆã—ã¾ã—ãŸ"

      - name: æœ€æ–°ã®å¤‰æ›´ã‚’å–å¾—ã—ã¦ãƒ—ãƒƒã‚·ãƒ¥
        if: steps.dedup_check.outputs.has_new_content == 'true'
        run: |
          git config pull.rebase true
          git config rebase.autoStash true
          for i in {1..3}; do
            echo "ãƒ—ãƒƒã‚·ãƒ¥è©¦è¡Œ $i å›ç›®"
            if git push origin main; then
              echo "ãƒ—ãƒƒã‚·ãƒ¥ã«æˆåŠŸã—ã¾ã—ãŸ"
              break
            else
              echo "ãƒ—ãƒƒã‚·ãƒ¥ã«å¤±æ•—ã—ãŸãŸã‚æœ€æ–°ã®å¤‰æ›´ã‚’å–å¾—ã—ã¾ã™..."
              git pull origin main --no-edit || true
              if [ $i -eq 3 ]; then
                echo "3å›ã®è©¦è¡Œã§ã‚‚ãƒ—ãƒƒã‚·ãƒ¥ã«å¤±æ•—ã—ã¾ã—ãŸ"
                exit 1
              fi
            fi
          done

      - name: GitHub Pagesæˆæœç‰©ã‚’æº–å‚™
        run: |
          SITE_DIR="public-site"
          rm -rf "$SITE_DIR"
          mkdir -p "$SITE_DIR"

          copy_file() {
            local file="$1"
            if [ -f "$file" ]; then
              cp "$file" "$SITE_DIR/"
            fi
          }

          for html in index.html settings.html login.html statistic.html; do
            copy_file "$html"
          done

          copy_dir() {
            local dir="$1"
            if [ -d "$dir" ]; then
              rsync -a "$dir" "$SITE_DIR/"
            fi
          }

          for dir in css js assets images data buy-me-a-coffee; do
            copy_dir "$dir"
          done

          copy_file README.md

      - name: GitHub Pagesæˆæœç‰©ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-pages-artifact@v4
        with:
          path: public-site

  deploy:
    runs-on: ubuntu-latest
    needs: build
    if: needs.build.result == 'success'
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: GitHub Pagesã«ãƒ‡ãƒ—ãƒ­ã‚¤
        id: deployment
        uses: actions/deploy-pages@v4
