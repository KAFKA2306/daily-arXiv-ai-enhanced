name: arXiv-daily-ai-enhanced

on:
  schedule:
    - cron: "30 1 * * *"
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: github-pages
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      has_new_content: ${{ steps.dedup_check.outputs.has_new_content }}
      skip_reason: ${{ steps.dedup_check.outputs.skip_reason }}
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          uv sync

      - name: Crawl arXiv papers
        id: crawl_step
        run: |
          source .venv/bin/activate
          today=$(date -u "+%Y-%m-%d")
          echo "ÂºÄÂßãÁà¨Âèñ $today ÁöÑarXivËÆ∫Êñá... / Starting to crawl $today arXiv papers..."

          # Ê£ÄÊü•‰ªäÊó•Êñá‰ª∂ÊòØÂê¶Â∑≤Â≠òÂú®ÔºåÂ¶ÇÂ≠òÂú®ÂàôÂà†Èô§ / Check if today's file exists, delete if found
          if [ -f "data/${today}.jsonl" ]; then
              echo "üóëÔ∏è ÂèëÁé∞‰ªäÊó•Êñá‰ª∂Â∑≤Â≠òÂú®ÔºåÊ≠£Âú®Âà†Èô§ÈáçÊñ∞ÁîüÊàê... / Found existing today's file, deleting for fresh start..."
              rm "data/${today}.jsonl"
              echo "‚úÖ Â∑≤Âà†Èô§Áé∞ÊúâÊñá‰ª∂Ôºödata/${today}.jsonl / Deleted existing file: data/${today}.jsonl"
          else
              echo "üìù ‰ªäÊó•Êñá‰ª∂‰∏çÂ≠òÂú®ÔºåÂáÜÂ§áÊñ∞Âª∫... / Today's file doesn't exist, ready to create new one..."
          fi

          cd daily_arxiv
          export OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
          export OPENAI_BASE_URL=${{ secrets.OPENAI_BASE_URL }}
          export LANGUAGE="${{ vars.LANGUAGE }}"
          if [ -z "$LANGUAGE" ]; then
            export LANGUAGE="Japanese"
          fi
          export CATEGORIES="${{ vars.CATEGORIES }}"
          export MODEL_NAME="${{ vars.MODEL_NAME }}"

          # Êèê‰æõÈªòËÆ§MODEL_NAMEÔºåÈÅøÂÖçÊú™ÈÖçÁΩÆÊó∂ÊµÅÁ®ã‰∏≠Êñ≠ / Provide fallback model name when not configured
          if [ -z "$MODEL_NAME" ]; then
            export MODEL_NAME="gemini-2.5-pro-preview"
          fi
          if [ -z "$OPENAI_BASE_URL" ] && [[ "$MODEL_NAME" == gemini-* ]]; then
            export OPENAI_BASE_URL="https://generativelanguage.googleapis.com/v1beta/openai"
          fi

          scrapy crawl arxiv -o ../data/${today}.jsonl

          if [ ! -f "../data/${today}.jsonl" ]; then
              echo "Áà¨ÂèñÂ§±Ë¥•ÔºåÊú™ÁîüÊàêÊï∞ÊçÆÊñá‰ª∂ / Crawling failed, no data file generated"
              exit 1
          fi

          echo "crawl_date=$today" >> $GITHUB_OUTPUT
          echo "Áà¨ÂèñÂÆåÊàê / Crawling completed"

      - name: Check for duplicates
        id: dedup_check
        run: |
          source .venv/bin/activate
          echo "ÊâßË°åÂéªÈáçÊ£ÄÊü•... / Performing intelligent deduplication check..."

          cd daily_arxiv
          set +e
          python daily_arxiv/check_stats.py
          dedup_exit_code=$?
          set -e

          echo "ÂéªÈáçÊ£ÄÊü•ÈÄÄÂá∫Á†Å: $dedup_exit_code / Dedup check exit code: $dedup_exit_code"
          echo "dedup_exit_code=$dedup_exit_code" >> $GITHUB_OUTPUT

          case $dedup_exit_code in
              0)
                  echo "has_new_content=true" >> $GITHUB_OUTPUT
                  ;;
              1)
                  echo "has_new_content=false" >> $GITHUB_OUTPUT
                  echo "skip_reason=no_new_content" >> $GITHUB_OUTPUT
                  ;;
              2)
                  echo "has_new_content=false" >> $GITHUB_OUTPUT
                  echo "skip_reason=processing_error" >> $GITHUB_OUTPUT
                  exit 1
                  ;;
              *)
                  echo "‚ùå Êú™Áü•ÈÄÄÂá∫Á†ÅÔºåÂÅúÊ≠¢Â∑•‰ΩúÊµÅ / Unknown exit code, stop workflow"
                  echo "has_new_content=false" >> $GITHUB_OUTPUT
                  echo "skip_reason=unknown_error" >> $GITHUB_OUTPUT
                  exit 1
                  ;;
          esac

      - name: AI Enhancement Processing
        if: steps.dedup_check.outputs.has_new_content == 'true'
        run: |
          source .venv/bin/activate
          today=${{ steps.crawl_step.outputs.crawl_date }}
          echo "ÂºÄÂßãAIÂ¢ûÂº∫Â§ÑÁêÜ... / Starting AI enhancement processing..."

          cd ai
          export OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
          export OPENAI_BASE_URL=${{ secrets.OPENAI_BASE_URL }}
          export LANGUAGE="${{ vars.LANGUAGE }}"
          export MODEL_NAME="${{ vars.MODEL_NAME }}"
          if [ -z "$MODEL_NAME" ]; then
            export MODEL_NAME="gemini-2.5-pro-preview"
          fi
          if [ -z "$OPENAI_BASE_URL" ] && [[ "$MODEL_NAME" == gemini-* ]]; then
            export OPENAI_BASE_URL="https://generativelanguage.googleapis.com/v1beta/openai"
          fi

          python enhance.py --data ../data/${today}.jsonl
          if [ $? -ne 0 ]; then
              echo "AIÂ§ÑÁêÜÂ§±Ë¥• / AI processing failed"
              exit 1
          fi
          echo "AIÂ¢ûÂº∫Â§ÑÁêÜÂÆåÊàê / AI enhancement processing completed"

      - name: Convert to Markdown
        if: steps.dedup_check.outputs.has_new_content == 'true'
        run: |
          source .venv/bin/activate
          today=${{ steps.crawl_step.outputs.crawl_date }}
          echo "ËΩ¨Êç¢‰∏∫MarkdownÊ†ºÂºè... / Converting to Markdown format..."

          export LANGUAGE="${{ vars.LANGUAGE }}"
          cd to_md
          AI_FILE="../data/${today}_AI_enhanced_${LANGUAGE}.jsonl"

          if [ -f "$AI_FILE" ]; then
              echo "‰ΩøÁî®AIÂ¢ûÂº∫Êñá‰ª∂ËøõË°åËΩ¨Êç¢... / Using AI enhanced file for conversion..."
              python convert.py --data "$AI_FILE"
          else
              echo "ÈîôËØØÔºöÊú™ÊâæÂà∞AIÂ¢ûÂº∫Êñá‰ª∂ / Error: AI enhanced file not found"
              echo "AIÊñá‰ª∂: $AI_FILE"
              exit 1
          fi

          if [ $? -ne 0 ]; then
              echo "MarkdownËΩ¨Êç¢Â§±Ë¥• / Markdown conversion failed"
              exit 1
          fi
          echo "MarkdownËΩ¨Êç¢ÂÆåÊàê / Markdown conversion completed"

      - name: Update file list
        if: steps.dedup_check.outputs.has_new_content == 'true'
        run: |
          echo "Êõ¥Êñ∞Êñá‰ª∂ÂàóË°®... / Updating file list..."
          ls data/*.jsonl | sed 's|data/||' > assets/file-list.txt
          echo "Êñá‰ª∂ÂàóË°®Êõ¥Êñ∞ÂÆåÊàê / File list updated"

      - name: Update README catalog
        if: steps.dedup_check.outputs.has_new_content == 'true'
        run: |
          if [ -f "update_readme.py" ]; then
            source .venv/bin/activate
            python update_readme.py
          else
            echo "README„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÅåË¶ã„Å§„Åã„Çâ„Å™„ÅÑ„Åü„ÇÅ„Çπ„Ç≠„ÉÉ„Éó / update_readme.py missing, skip README refresh"
          fi

      - name: Generate password hash and inject into config
        if: steps.dedup_check.outputs.has_new_content == 'true'
        env:
          ACCESS_PASSWORD: ${{ secrets.ACCESS_PASSWORD }}
        run: |
          echo "üîê Generating password hash for authentication..."

          if [ -z "$ACCESS_PASSWORD" ]; then
            echo "‚ö†Ô∏è  WARNING: ACCESS_PASSWORD not set in Secrets"
            PASSWORD_HASH="DISABLED_NO_PASSWORD_SET_IN_SECRETS"
          else
            PASSWORD_HASH=$(echo -n "$ACCESS_PASSWORD" | openssl dgst -sha256 -hex | awk '{print $2}')
            echo "‚úÖ Password hash generated successfully"
          fi
          export PASSWORD_HASH

          if [ ! -f "js/auth-config.js" ]; then
            echo "‚ùå ERROR: js/auth-config.js not found!"
            exit 1
          fi

          python - <<'PY'
import os
from pathlib import Path
hash_value = os.environ.get('PASSWORD_HASH', 'DISABLED_NO_PASSWORD_SET_IN_SECRETS')
path = Path('js/auth-config.js')
text = path.read_text()
if "passwordHash" not in text:
    raise SystemExit('passwordHash key missing in auth-config.js')
import re
new_text = re.sub(r"(passwordHash:\s*)'[^']+'", rf"\1'{hash_value}'", text, count=1)
path.write_text(new_text)
PY

          echo "üîê Authentication setup complete"

      - name: Summary
        run: |
          if [ "${{ steps.dedup_check.outputs.has_new_content }}" = "true" ]; then
            echo "‚úÖ Â∑•‰ΩúÊµÅÂÆåÊàêÔºöÂéªÈáçÂèëÁé∞Êñ∞ÂÜÖÂÆπÂπ∂ÊàêÂäüÂ§ÑÁêÜ / Workflow completed: Smart deduplication found new content and processed successfully"
          else
            case "${{ steps.dedup_check.outputs.skip_reason }}" in
              "no_new_content")
                echo "‚ÑπÔ∏è Â∑•‰ΩúÊµÅÂÆåÊàêÔºöÂéªÈáçÂêéÊó†Êñ∞ÂÜÖÂÆπ / Workflow completed: No new content after smart deduplication"
                ;;
              "processing_error")
                echo "‚ö†Ô∏è Â∑•‰ΩúÊµÅÂÆåÊàêÔºöÂéªÈáçÂ§ÑÁêÜÂá∫Èîô / Workflow completed: Deduplication processing error"
                ;;
              "unknown_error")
                echo "‚ö†Ô∏è Â∑•‰ΩúÊµÅÂÆåÊàêÔºöÊú™Áü•ÈîôËØØ / Workflow completed: Unknown error"
                ;;
              *)
                echo "‚ÑπÔ∏è Â∑•‰ΩúÊµÅÂÆåÊàêÔºöÊú™Áü•ÂéüÂõ†Ë∑≥ËøáÂ§ÑÁêÜ / Workflow completed: Skipped for unknown reason"
                ;;
            esac
          fi

      - name: Commit changes
        if: steps.dedup_check.outputs.has_new_content == 'true'
        run: |
          git config --global user.email "${{ vars.EMAIL }}"
          git config --global user.name "${{ vars.NAME }}"
          git add .
          if git diff --staged --quiet; then
            echo "Ê≤°ÊúâÂèòÊõ¥ÈúÄË¶ÅÊèê‰∫§ / No changes to commit"
            exit 0
          fi
          git commit -m "update: $(date -u '+%Y-%m-%d') arXiv papers"
          echo "ÂèòÊõ¥Â∑≤Êèê‰∫§ / Changes committed"

      - name: Pull latest changes and push
        if: steps.dedup_check.outputs.has_new_content == 'true'
        run: |
          git config pull.rebase true
          git config rebase.autoStash true
          for i in {1..3}; do
            echo "Êé®ÈÄÅÂ∞ùËØï $i / Push attempt $i"
            if git push origin main; then
              echo "Êé®ÈÄÅÊàêÂäü / Push successful"
              break
            else
              echo "Êé®ÈÄÅÂ§±Ë¥•ÔºåÊãâÂèñÊúÄÊñ∞ÂèòÊõ¥... / Push failed, pulling latest changes..."
              git pull origin main --no-edit || true
              if [ $i -eq 3 ]; then
                echo "3Ê¨°Â∞ùËØïÂêéÊé®ÈÄÅÂ§±Ë¥• / Failed to push after 3 attempts"
                exit 1
              fi
            fi
          done

      - name: Prepare GitHub Pages artifact
        run: |
          SITE_DIR="public-site"
          rm -rf "$SITE_DIR"
          mkdir -p "$SITE_DIR"

          copy_file() {
            local file="$1"
            if [ -f "$file" ]; then
              cp "$file" "$SITE_DIR/"
            fi
          }

          for html in index.html settings.html login.html statistic.html; do
            copy_file "$html"
          done

          copy_dir() {
            local dir="$1"
            if [ -d "$dir" ]; then
              rsync -a "$dir" "$SITE_DIR/"
            fi
          }

          for dir in css js assets images data buy-me-a-coffee; do
            copy_dir "$dir"
          done

          copy_file README.md

      - name: Upload GitHub Pages artifact
        uses: actions/upload-pages-artifact@v4
        with:
          path: public-site

  deploy:
    runs-on: ubuntu-latest
    needs: build
    if: needs.build.result == 'success'
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
